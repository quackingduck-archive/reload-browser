<script>
// window.probes=true
function probe() { if (window.probes) console.log(arguments) }
</script>

<script>
// the probe messages don't appear while the browser is blocked during a
// request ... still works though

var lastConnectionTime;

function pullReload() {
  try {
    probe('connecting to server')
    var xhr = new XMLHttpRequest()
    // syncronous request
    xhr.open("GET","http://localhost:35729/",false)
    lastConnectionTime = new Date();
    xhr.send()
    probe('connection completed')
    probe(xhr.responseText)
    // Reloads active tab in active window.
    chrome.tabs.reload()
    // leave the current stack
    setTimeout(pullReload, 1)
  } catch(error) {
    probe('error: ', error)
    probe('ms since last connection', (new Date() - lastConnectionTime))

    var retryIn;
    if ((new Date() - lastConnectionTime) < 1000) {
      probe('connection failure')
      retryIn = 1000
    }
    else {
      probe('request timeout')
      retryIn = 1
    }
    setTimeout(pullReload, retryIn)
  }
}

pullReload()
</script>
